<!DOCTYPE html>

<html>
<head>
    <title>Page Title</title>
     <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0"/>
    <style>
        html, body {
            height: 100%;
            margin:0;
            padding:0;
            
            font-family: arial;
          }
          #output{
            position: absolute;
            top:0;
            left:0;
          }
          
          #pad{
            float:left;
            
          }
          #fire{
            float: left;
            height:80px;
            background-color:#000000;
            color:#fff;
            line-height: 80px;
            position: absolute;
            bottom:20px;
            left:20px;
            right:20px;
            font-size: 18px;
            text-align: center;
          }
       
          
         
    </style>
    
    
    
    
</head>

<body>


<div id="pad"></div>
 <div id="fire">
    fire!
  </div>
<div id="output"></div>
 <script src="/socket.io/socket.io.js"></script>
<script>
      
    //http://jsfiddle.net/jessefreeman/rM46q/1/
    //http://johnstejskal.com/wp/virtual-joystick-for-mobile-games-using-as3/
        //SOCKET
         var socket
       
       socket =io();
    socket.emit('connect mobile',{user:"ws"});
     socket.on("on color",function(color){
                backgroundColor=color;
                //update();
                
             })
        
        var canvas;
        var context;
        
        var tension =  .5;
        var xspeed = 0;
        var yspeed = 0;
        var padRadius;
        var stickRadius;
        
        var stickX = 0;
        var stickY = 0;
        var centerX = 0;
        var centerY = 0;
        var angle = 0;
        var lastAngle = 0;
        var backgroundColor = "#cccccc";
        var padColor = "#eeeeee";
        var stickColor = "#666666";
        var dragging = false;
        var output = document.getElementById("output"); 
        var fire = document.getElementById("fire");
        var keys = [fire];
       
        fire.addEventListener("touchstart", onFire);
        fire.addEventListener("touchend", onFireRelease);
        function onFire(event) {
         event.preventDefault();
          fireBullet = true;
           socket.emit('fire',{fire:fireBullet});//change
        }
        function onFireRelease(event) {
         event.preventDefault();
          fireBullet = false;
          socket.emit('fire',{fire:fireBullet});//change
        }
         
         
        //CREATE CANVAS
        canvas = document.createElement('canvas');
        canvas.id = 'canvas';
        document.body.appendChild(canvas);  
        
        //GET CONTEXT
        context = canvas.getContext('2d');
        
        //TOUCH
        canvas.addEventListener("touchstart", onTouch);
        canvas.addEventListener("touchmove", onTouch);
        canvas.addEventListener("touchend", onRelease);
        
        //MOUSE
        canvas.onmousemove = function (e) {
            stickX = e.offsetX;
            stickY = e.offsetY;
        }
        canvas.onmouseout = function (e) {
           stickX = centerX;
            stickY = centerY;
        }
        
        
        //RESIZE
        window.addEventListener("resize", onResize);
        function onResize() {
            if (window.innerHeight<window.innerWidth) {
                canvasWidth = window.innerHeight;
               
            }else{
                canvasWidth = window.innerWidth;
            }
            
           
            
            canvasHeight =  canvasWidth;
            stickRadius = (canvasWidth/2)*.2;
            padRadius = (canvasWidth/2)-stickRadius;
            
            centerX = canvasWidth/2;
            centerY = canvasWidth/2;
            
            stickX = centerX;
            stickY = centerY;
            
           
            
        }
        onResize();

        //TOUCH
        function onTouch(event) {
            event.preventDefault();
            dragging = true;
            
            //update(event.changedTouches[0].pageX, event.changedTouches[0].pageY);
            stickX = event.changedTouches[0].pageX;
            stickY = event.changedTouches[0].pageY;
            
           //update();
            
            
        }
        //RELEASE
        function onRelease(event) {
            event.preventDefault();
            dragging = false;
            //stickX = centerX;
            //stickY = centerY;
            //update();
        }
        
       // update();
         
        var animate = window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        function(callback) { window.setTimeout(callback, 1000) };
      
      animate(update)
       
        
        // Loop
       // setInterval(onTimerTick, 33);
        
        // Render Loop
        function update() {
        
            //REDRAW CANVAS
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            context.fillStyle = backgroundColor;
            context.fillRect(0,0,canvasWidth,canvasHeight);
            
            
            //DRAW PAD
            context.beginPath();
            context.arc(centerX, centerY, padRadius, 0, 2 * Math.PI, false);
            context.fillStyle = padColor;
            context.fill();
        
            // GET POIT FOR STICK;
            var newPoint = limit(centerX, centerY, stickX, stickY, padRadius);
        
            //STICK
            context.beginPath();
            context.arc(newPoint.x, newPoint.y, stickRadius, 0, 2 * Math.PI, false);
            context.fillStyle = stickColor;
            context.fill();
            
            //DEBUG
            //angle = Math.atan2(newPoint.y-centerY,newPoint.x-centerX)/(Math.PI/180);
           
            
            
           // moveY = Math.sin(angle*(Math.PI/180));
            //moveX = Math.cos(angle*(Math.PI/180));
            //moveY = Math.sin(angle*(Math.PI/180))*(newPoint.x/8);
            //moveX = Math.cos(angle*(Math.PI/180))*(newPoint.x/8);
           
            if (dragging) {
                var dx = newPoint.x-centerX;
                var dy = newPoint.y-centerY;
                angle = Math.atan2(dy,dx);
            
            
            
                //output.innerHTML = "horizontal : " +Math.round(Math.abs(newPoint.x/centerX)*100)+" vertical : "+Math.round(Math.abs(newPoint.y/centerY)*100)+"angle : "+angle;
                output.innerHTML = "horizontal : " +Math.abs(newPoint.x/centerX)+" vertical : "+Math.abs(newPoint.y/centerY)+"angle : "+angle;
                socket.emit('move',{direction:{x:newPoint.x/centerX,y:newPoint.y/centerY,angle:angle}});//change
                //lastAngle = angle;
            }else{
                
                stickX = centerX;
                stickY = centerY;
                //socket.emit('move',{direction:{x:newPoint.x,y:newPoint.y,angle:lastAngle}});//change
                
            }
            
            
            
            //LOOP
            animate(update)
        }
        
        
        
        function limit(x1, y1, x2, y2, radius) {
        
            // the vector between the two points
            var dx = x2 - x1,
                dy = y2 - y1,
                distanceSquared = (dx * dx) + (dy * dy);
            if (distanceSquared <= radius * radius) {
                return {
                    x: x2,
                    y: y2,
                    dist: radius
                };
            } else {
                var distance = Math.sqrt(distanceSquared),
                    ratio = radius / distance;
        
                return {
                    x: (dx * ratio) + x1,
                    y: (dy * ratio) + y1,
                    dist: radius
                };
            }
        }
        
        
        
    </script>

</body>
</html>
